---
import Base from '../../../layouts/Base.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).filter(post => !post.data.draft);

  // Collect all unique tags
  const tags = new Set<string>();
  posts.forEach(post => {
    post.data.tags?.forEach((tag: string) => tags.add(tag));
  });

  // Generate a path for each tag
  return Array.from(tags).map(tag => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter(post => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}
---

<Base title={`Posts tagged: ${tag}`} description={`All blog posts tagged with "${tag}".`}>
  <section>
    <a
      href="/blog/tags/"
      class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 mb-4 inline-block"
    >
      &larr; All tags
    </a>
    <h1 class="text-3xl font-bold mb-8">Posts tagged: {tag}</h1>
    {posts.length === 0 ? (
      <p class="text-gray-600 dark:text-gray-400">No posts with this tag.</p>
    ) : (
      <ul class="space-y-8">
        {posts.map((post) => (
          <li>
            <a
              href={`/blog/${post.slug}/`}
              class="group block"
            >
              <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                {post.data.title}
              </h2>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                {formatDate(post.data.pubDate)}
                {post.data.description && (
                  <span> &middot; {post.data.description}</span>
                )}
              </p>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Base>
